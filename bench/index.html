<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Benchmark Summary - osmpbfdb</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
            }
            table {
                border-collapse: collapse;
                margin: 10px 0;
            }
            th,
            td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            th {
                background: #f0f0f0;
            }
            .chart-container {
                margin: 15px 0;
                max-width: 600px;
            }
            canvas {
                max-width: 100%;
            }
            h2 {
                border-bottom: 1px solid #ccc;
                padding-bottom: 5px;
            }
            h3 {
                margin-top: 20px;
            }
            .tabs {
                margin: 10px 0;
            }
            .tabs button {
                padding: 5px 15px;
                margin-right: 5px;
                cursor: pointer;
            }
            .tabs button.active {
                background: #333;
                color: white;
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }
        </style>
    </head>
    <body>
        <h1>Benchmark Results</h1>
        <p>
            Repository:
            <a href="https://github.com/royalcat/osmpbfdb"
                >github.com/royalcat/osmpbfdb</a
            >
        </p>
        <p id="last-update"></p>

        <div id="main">
            <p>Loading benchmark data...</p>
        </div>

        <hr />
        <p>
            <small
                >Powered by
                <a
                    href="https://github.com/marketplace/actions/continuous-benchmark"
                    >github-action-benchmark</a
                ></small
            >
        </p>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.2/dist/Chart.min.js"></script>
        <script>
            (function () {
                const benchmarkConfigs = [
                    {
                        branch: "continuous-benchmarking",
                        platform: "ubuntu-24.04",
                        cgo: "cgo-0",
                        label: "CGO Disabled",
                    },
                    {
                        branch: "continuous-benchmarking",
                        platform: "ubuntu-24.04",
                        cgo: "cgo-1",
                        label: "CGO Enabled",
                    },
                    {
                        branch: "continuous-benchmarking",
                        platform: "ubuntu-24.04-arm",
                        cgo: "cgo-0",
                        label: "CGO Disabled",
                    },
                    {
                        branch: "continuous-benchmarking",
                        platform: "ubuntu-24.04-arm",
                        cgo: "cgo-1",
                        label: "CGO Enabled",
                    },
                ];

                const platformNames = {
                    "ubuntu-24.04": "Ubuntu 24.04 (x86_64)",
                    "ubuntu-24.04-arm": "Ubuntu 24.04 (ARM64)",
                };

                async function loadData(config) {
                    const url = `branch/${config.branch}/${config.platform}/${config.cgo}/default/data.js`;
                    try {
                        const response = await fetch(url);
                        if (!response.ok) return null;
                        const text = await response.text();
                        const jsonStr = text
                            .replace("window.BENCHMARK_DATA = ", "")
                            .trim();
                        return JSON.parse(jsonStr);
                    } catch (e) {
                        console.warn("Failed to load " + url, e);
                        return null;
                    }
                }

                function collectBenches(entries) {
                    const map = new Map();
                    for (const entry of entries) {
                        for (const bench of entry.benches) {
                            const result = {
                                commit: entry.commit,
                                date: entry.date,
                                tool: entry.tool,
                                bench,
                            };
                            if (!map.has(bench.name)) {
                                map.set(bench.name, []);
                            }
                            map.get(bench.name).push(result);
                        }
                    }
                    return map;
                }

                function renderChart(container, name, dataset) {
                    const div = document.createElement("div");
                    div.className = "chart-container";
                    const canvas = document.createElement("canvas");
                    div.appendChild(canvas);
                    container.appendChild(div);

                    new Chart(canvas, {
                        type: "line",
                        data: {
                            labels: dataset.map((d) => d.commit.id.slice(0, 7)),
                            datasets: [
                                {
                                    label: name,
                                    data: dataset.map((d) => d.bench.value),
                                    borderColor: "#00add8",
                                    backgroundColor: "rgba(0,173,216,0.2)",
                                    fill: true,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            scales: {
                                xAxes: [
                                    {
                                        scaleLabel: {
                                            display: true,
                                            labelString: "Commit",
                                        },
                                    },
                                ],
                                yAxes: [
                                    {
                                        scaleLabel: {
                                            display: true,
                                            labelString:
                                                dataset[0]?.bench.unit || "",
                                        },
                                        ticks: { beginAtZero: true },
                                    },
                                ],
                            },
                            tooltips: {
                                callbacks: {
                                    afterTitle: (items) => {
                                        const d = dataset[items[0].index];
                                        return (
                                            d.commit.message +
                                            "\n" +
                                            d.commit.timestamp
                                        );
                                    },
                                    label: (item) =>
                                        item.value +
                                        " " +
                                        (dataset[item.index]?.bench.unit || ""),
                                },
                            },
                            onClick: (e, elems) => {
                                if (elems.length > 0) {
                                    window.open(
                                        dataset[elems[0]._index].commit.url,
                                        "_blank",
                                    );
                                }
                            },
                        },
                    });
                }

                function renderComparisonTable(allData, container) {
                    const comparison = new Map();
                    for (const { config, data } of allData) {
                        if (!data?.entries) continue;
                        for (const entries of Object.values(data.entries)) {
                            for (const entry of entries) {
                                for (const bench of entry.benches) {
                                    if (!comparison.has(bench.name)) {
                                        comparison.set(bench.name, {});
                                    }
                                    comparison.get(bench.name)[
                                        `${config.platform}-${config.cgo}`
                                    ] = {
                                        value: bench.value,
                                        unit: bench.unit,
                                    };
                                }
                            }
                        }
                    }

                    if (comparison.size === 0) return;

                    const h = document.createElement("h3");
                    h.textContent = "Latest Results Comparison";
                    container.appendChild(h);

                    const table = document.createElement("table");
                    const platforms = ["ubuntu-24.04", "ubuntu-24.04-arm"];
                    const cgos = ["cgo-0", "cgo-1"];

                    let html = "<thead><tr><th>Benchmark</th>";
                    for (const p of platforms) {
                        for (const c of cgos) {
                            const pName = p.includes("arm")
                                ? "ARM64"
                                : "x86_64";
                            const cName = c === "cgo-1" ? "CGO" : "No CGO";
                            html += `<th>${pName} / ${cName}</th>`;
                        }
                    }
                    html += "</tr></thead><tbody>";

                    for (const [name, results] of comparison) {
                        html += `<tr><td>${name}</td>`;
                        for (const p of platforms) {
                            for (const c of cgos) {
                                const r = results[`${p}-${c}`];
                                html += `<td>${r ? r.value.toLocaleString() + " " + r.unit.split("\t")[0] : "-"}</td>`;
                            }
                        }
                        html += "</tr>";
                    }
                    html += "</tbody>";
                    table.innerHTML = html;
                    container.appendChild(table);
                }

                function renderPlatform(platformKey, configs, container) {
                    const h = document.createElement("h3");
                    h.textContent = platformNames[platformKey] || platformKey;
                    container.appendChild(h);

                    const tabs = document.createElement("div");
                    tabs.className = "tabs";
                    const contents = document.createElement("div");

                    configs.forEach(({ config, data }, i) => {
                        const tabId = `${platformKey}-${config.cgo}`.replace(
                            /[^a-zA-Z0-9]/g,
                            "-",
                        );

                        const btn = document.createElement("button");
                        btn.textContent = config.label;
                        if (i === 0) btn.className = "active";
                        btn.onclick = () => {
                            tabs.querySelectorAll("button").forEach((b) =>
                                b.classList.remove("active"),
                            );
                            contents
                                .querySelectorAll(".tab-content")
                                .forEach((c) => c.classList.remove("active"));
                            btn.classList.add("active");
                            document
                                .getElementById(tabId)
                                .classList.add("active");
                        };
                        tabs.appendChild(btn);

                        const content = document.createElement("div");
                        content.id = tabId;
                        content.className =
                            "tab-content" + (i === 0 ? " active" : "");

                        if (data?.entries) {
                            for (const entries of Object.values(data.entries)) {
                                const benchSet = collectBenches(entries);
                                for (const [name, benches] of benchSet) {
                                    renderChart(content, name, benches);
                                }
                            }
                        } else {
                            content.innerHTML = "<p>No data available</p>";
                        }
                        contents.appendChild(content);
                    });

                    container.appendChild(tabs);
                    container.appendChild(contents);
                }

                async function init() {
                    const main = document.getElementById("main");

                    const allData = await Promise.all(
                        benchmarkConfigs.map(async (config) => ({
                            config,
                            data: await loadData(config),
                        })),
                    );

                    let lastUpdate = 0;
                    for (const { data } of allData) {
                        if (data?.lastUpdate > lastUpdate)
                            lastUpdate = data.lastUpdate;
                    }
                    document.getElementById("last-update").textContent =
                        lastUpdate
                            ? "Last updated: " +
                              new Date(lastUpdate).toLocaleString()
                            : "";

                    main.innerHTML = "";

                    // Group by branch
                    const branches = new Map();
                    for (const item of allData) {
                        const b = item.config.branch;
                        if (!branches.has(b)) branches.set(b, []);
                        branches.get(b).push(item);
                    }

                    for (const [branchName, branchData] of branches) {
                        const section = document.createElement("section");
                        const h2 = document.createElement("h2");
                        h2.textContent = "Branch: " + branchName;
                        section.appendChild(h2);

                        renderComparisonTable(branchData, section);

                        // Group by platform
                        const platforms = new Map();
                        for (const item of branchData) {
                            const p = item.config.platform;
                            if (!platforms.has(p)) platforms.set(p, []);
                            platforms.get(p).push(item);
                        }

                        for (const [platformKey, platformData] of platforms) {
                            renderPlatform(platformKey, platformData, section);
                        }

                        main.appendChild(section);
                    }

                    if (branches.size === 0) {
                        main.innerHTML = "<p>No benchmark data found.</p>";
                    }
                }

                init();
            })();
        </script>
    </body>
</html>
